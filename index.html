<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Metrix SDK Demo</title>

    <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background-color: #f9fafb;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #111827;
        margin: 0;
        padding: 0;
      }

      main {
        max-width: 1100px;
        margin: 20px auto;
        padding: 20px;
      }

      .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 24px;
        margin-bottom: 24px;
        transition: 0.2s ease;
      }

      .card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      h3,
      h4,
      h5 {
        margin-top: 12px;
        margin-bottom: 8px;
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      input[type="password"],
      input[type="checkbox"],
      input:not([type]),
      button {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }

      input {
        width: 95% !important;
      }

      input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }

      label {
        font-weight: 500;
      }

      .btn-primary {
        background-color: #2563eb;
        color: white;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: 0.2s ease;
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
      }
      .btn-primary:hover {
        background-color: #1e40af;
      }
      .btn-danger {
        background-color: #ef4444;
        color: white;
      }
      .btn-warning {
        background-color: #f59e0b;
        color: white;
      }
      .btn-disabled {
        background-color: #9ca3af;
        color: white;
        cursor: not-allowed;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        align-items: center;
      }

      .row > div {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .attr-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 8px;
        align-items: center;
      }

      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      hr {
        margin: 30px 0;
        border: 0;
        border-top: 1px solid #e5e7eb;
      }

      .add-btn {
        background-color: #10b981;
        width: auto;
        padding: 8px 14px;
        margin-top: 8px;
        border-radius: 8px;
        font-size: 0.95rem;
        color: white;
        border: none;
        cursor: pointer;
      }
      .add-btn:hover {
        background-color: #059669;
      }

      #init-status,
      #login-status {
        font-weight: bold;
        margin-top: 10px;
      }

      @media (max-width: 768px) {
        main {
          padding: 16px;
        }
        .card {
          padding: 16px;
        }
        button {
          font-size: 0.95rem;
        }
        h3 {
          font-size: 1.1rem;
        }
      }
    </style>

    <script>
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        },
      });
    </script>
  </head>

  <body>
    <main>
      <!-- INIT SECTION -->
      <div class="card">
        <div class="flex-between">
          <h2>Metrix SDK Initialization</h2>
          <div>
            <label for="stg-checkbox">Use Staging:</label>
            <input
              type="checkbox"
              id="stg-checkbox"
              style="transform: scale(1.2)"
            />
          </div>
        </div>
        <div class="row">
          <div>
            <label>App ID:</label>
            <input id="init-appid-input" placeholder="Enter App ID" />
          </div>
          <div>
            <label>API Key:</label>
            <input id="init-apikey-input" placeholder="Enter API Key" />
          </div>
          <div>
            <label>Push public key (optional):</label>
            <input
              id="init-public-key-input"
              placeholder="Public Key (optional)"
            />
          </div>
        </div>
        <div class="row">
          <div>
            <button id="init-button" class="btn-primary">Initialize SDK</button>
          </div>
          <div>
            <button id="close-button" class="btn-danger">Close Session</button>
          </div>
        </div>

        <p id="init-status" style="color: red">Not initialized</p>
      </div>

      <!-- EVENT SECTION -->
      <div id="send-event-box" hidden>
        <div class="card">
          <h3>User Authentication</h3>
          <div class="row">
            <div>
              <input
                id="login-input"
                placeholder="customer@mycompany.com"
                style="margin-bottom: 0"
              />
            </div>
            <div>
              <button id="login-button" class="btn-primary">Login</button>
            </div>
            <div>
              <button id="logout-button" class="btn-warning">Logout</button>
            </div>
          </div>
          <p id="login-status" style="color: red">You're anonymous</p>
        </div>

        <!-- USER ATTRIBUTES -->
        <div class="card">
          <div style="display: flex">
            <label for="show-user-send"
              ><strong>Show user attribute section</strong></label
            >
            <input
              type="checkbox"
              id="show-user-send"
              style="width: 50px !important; margin-bottom: 8px"
            />
          </div>

          <div id="send-user-box" hidden>
            <div class="row">
              <div>
                <label>First Name:</label>
                <input id="first-name-input" placeholder="First Name" />
              </div>
              <div>
                <label>Last Name:</label>
                <input id="last-name-input" placeholder="Last Name" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Phone Number:</label>
                <input id="phone-input" placeholder="Phone Number" />
              </div>
              <div>
                <label>Email:</label>
                <input id="email-input" placeholder="Email" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>City:</label>
                <input id="city-input" placeholder="City" />
              </div>
              <div>
                <label>Birth Date:</label>
                <input id="birth-date-input" placeholder="Timestamp" />
              </div>
            </div>

            <h4>Custom Attributes:</h4>
            <div id="user-attributes-container"></div>
            <div
              style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px"
            >
              <button id="add-user-attribute" class="add-btn">
                + Add Attribute
              </button>
              <button id="user-att-button" class="btn-primary">
                Send User Attributes
              </button>
            </div>
          </div>
        </div>

        <!-- EVENTS -->
        <div id="event-box">
          <div class="card">
            <h3>Send Event by Slug</h3>
            <div style="margin-bottom: 8px">
              <input
                id="sample-event-c-slug-input"
                placeholder="Event Slug (5 chars required)"
              />
            </div>
            <div id="slug-attributes-container"></div>
            <div
              style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px"
            >
              <button id="add-slug-attribute" class="add-btn">
                + Add Attribute
              </button>
              <button id="sample-event-button" class="btn-primary" disabled>
                Send Event by Slug
              </button>
            </div>
          </div>

          <div class="card">
            <h3>Send Event by Name</h3>
            <div style="margin-bottom: 8px">
              <input
                id="sample-name-event-c-input"
                class="field-input"
                placeholder="Event Name"
              />
            </div>
            <div id="name-attributes-container"></div>
            <div
              style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px"
            >
              <button id="add-name-attribute" class="add-btn">
                + Add Attribute
              </button>
              <button
                id="sample-name-event-button"
                class="btn-primary"
                disabled
              >
                Send Event by Name
              </button>
            </div>
          </div>

          <div class="card">
            <h3>Business Event by Slug</h3>
            <div style="margin-bottom: 8px">
              <input
                id="sample-business-event-c-slug-input"
                class="field-input"
                placeholder="Business Event Slug (5 chars required)"
              />
            </div>
            <div id="business-attributes-container"></div>
            <div
              style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px"
            >
              <button id="add-business-attribute" class="add-btn">
                + Add Attribute
              </button>
              <button
                id="sample-business-event-button"
                class="btn-primary"
                disabled
              >
                Send Business Event
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        function mainThread() {
          function createAttributeRow(container) {
            const row = document.createElement("div");
            row.className = "attr-row";
            const key = document.createElement("input");
            key.className = "attr-key field-input";
            key.placeholder = "Key";
            const value = document.createElement("input");
            value.className = "attr-value field-input";
            value.placeholder = "Value";
            row.appendChild(key);
            row.appendChild(value);
            container.appendChild(row);
          }

          function setupAddButton(addBtnId, containerId) {
            const addBtn = document.getElementById(addBtnId);
            const container = document.getElementById(containerId);
            createAttributeRow(container);
            addBtn.addEventListener("click", (e) => {
              e.preventDefault();
              createAttributeRow(container);
            });
          }

          let username = localStorage.getItem("username");
          const appId = localStorage.getItem("appId");
          const apiKey = localStorage.getItem("apiKey");
          const publicKey = localStorage.getItem("publicKey");

          const stgCheckbox = document.getElementById("stg-checkbox");
          if (typeof useStg !== "undefined") stgCheckbox.checked = useStg;

          setupAddButton("add-user-attribute", "user-attributes-container");
          setupAddButton("add-slug-attribute", "slug-attributes-container");
          setupAddButton("add-name-attribute", "name-attributes-container");
          setupAddButton(
            "add-business-attribute",
            "business-attributes-container"
          );

          if (appId && apiKey) {
            const cfg = {
              push: {
                enabled: !!publicKey,
                publicKey: publicKey || undefined,
                showBell: !!publicKey,
              },
              onSiteMessaging: { enabled: true },
            };
            if (window.Metrix && typeof Metrix.init === "function") {
              Metrix.init(appId, apiKey, cfg);
            }
            document.getElementById("init-appid-input").value = appId;
            document.getElementById("init-apikey-input").value = apiKey;
            document.getElementById("init-public-key-input").value =
              publicKey || "";
            document.getElementById("init-status").innerText =
              "Metrix initialized";
            document.getElementById("init-status").style.color = "green";
            document.getElementById("send-event-box").removeAttribute("hidden");
            document.getElementById("init-button").disabled = true;
          }

          if (username) {
            document.getElementById("login-status").innerHTML =
              "You're logged in as: " + username;
            document.getElementById("login-status").style.color = "green";
            document.getElementById("login-button").disabled = true;
            document.getElementById("login-input").value = username;
            document.getElementById("event-box").removeAttribute("hidden");
            if (window.Metrix && typeof Metrix.authorizeUser === "function") {
              Metrix.authorizeUser(username);
            }
          }

          document.getElementById("init-button").onclick = () => {
            const appIdInput = document
              .getElementById("init-appid-input")
              .value.trim();
            const apiKeyInput = document
              .getElementById("init-apikey-input")
              .value.trim();
            const publicKeyInput = document
              .getElementById("init-public-key-input")
              .value.trim();

            if (!appIdInput || !apiKeyInput) {
              Toast.fire({
                icon: "error",
                title: "App ID and API Key are required",
              });
              return;
            }

            localStorage.setItem("appId", appIdInput);
            localStorage.setItem("apiKey", apiKeyInput);
            if (publicKeyInput)
              localStorage.setItem("publicKey", publicKeyInput);
            else localStorage.removeItem("publicKey");

            const cfg = {
              push: {
                enabled: !!publicKeyInput,
                publicKey: publicKeyInput || undefined,
                showBell: !!publicKeyInput,
              },
              onSiteMessaging: { enabled: true },
            };

            if (window.Metrix && typeof Metrix.init === "function") {
              Metrix.init(appIdInput, apiKeyInput, cfg);
            }

            document.getElementById("init-status").innerText =
              "Metrix initialized";
            document.getElementById("init-status").style.color = "green";
            document.getElementById("send-event-box").removeAttribute("hidden");
            document.getElementById("init-button").disabled = true;
            Toast.fire({ icon: "success", title: "SDK Initialized" });
          };

          function closeSession() {
            localStorage.removeItem("appId");
            localStorage.removeItem("apiKey");
            localStorage.removeItem("username");
            localStorage.removeItem("publicKey");
            if (window.Metrix && typeof Metrix.deauthorizeUser === "function") {
              Metrix.deauthorizeUser();
            }
            window.location.reload();
          }
          document.getElementById("close-button").onclick = closeSession;

          document.getElementById("login-button").onclick = () => {
            const u = document.getElementById("login-input").value.trim();
            if (!u) return;
            localStorage.setItem("username", u);
            if (window.Metrix && typeof Metrix.authorizeUser === "function") {
              Metrix.authorizeUser(u);
            }
            document.getElementById("login-status").innerHTML =
              "You're logged in as: " + u;
            document.getElementById("login-status").style.color = "green";
            document.getElementById("login-button").disabled = true;
            document.getElementById("event-box").removeAttribute("hidden");
            Toast.fire({ icon: "success", title: "Logged in" });
          };

          document.getElementById("logout-button").onclick = () => {
            localStorage.removeItem("username");
            if (window.Metrix && typeof Metrix.deauthorizeUser === "function") {
              Metrix.deauthorizeUser();
            }
            document.getElementById("login-button").disabled = false;
            document.getElementById("login-input").value = "";
            document.getElementById("login-status").innerHTML =
              "You're logged out!!!";
            document.getElementById("login-status").style.color = "red";
            document.getElementById("event-box").setAttribute("hidden", "");
            Toast.fire({ icon: "success", title: "Logged out" });
          };

          document.getElementById("show-user-send").onchange = (e) => {
            const checked = e.target.checked;
            const userSendBox = document.getElementById("send-user-box");
            if (checked) userSendBox.removeAttribute("hidden");
            else userSendBox.setAttribute("hidden", "");
          };

          function collectAttributesFrom(containerId) {
            const container = document.getElementById(containerId);
            const keys = container.querySelectorAll(".attr-key");
            const vals = container.querySelectorAll(".attr-value");
            const attrs = {};
            keys.forEach((kEl, idx) => {
              const k = kEl.value.trim();
              const v =
                vals[idx] && vals[idx].value ? vals[idx].value.trim() : "";
              if (k) attrs[k] = v;
            });
            return attrs;
          }

          document.getElementById("user-att-button").onclick = () => {
            const firstname = document
              .getElementById("first-name-input")
              .value.trim();
            const lastname = document
              .getElementById("last-name-input")
              .value.trim();
            const phone = document.getElementById("phone-input").value.trim();
            const email = document.getElementById("email-input").value.trim();
            const city = document.getElementById("city-input").value.trim();
            const birthDate = document
              .getElementById("birth-date-input")
              .value.trim();

            if (firstname) Metrix.setFirstName(firstname);
            if (lastname) Metrix.setLastName(lastname);
            if (phone) Metrix.setPhoneNumber(phone);
            if (email) Metrix.setEmail(email);
            if (city) Metrix.setCity(city);
            if (birthDate) Metrix.setBirthday(birthDate);

            const userAttrs = collectAttributesFrom(
              "user-attributes-container"
            );
            Object.keys(userAttrs).forEach((k) => {
              Metrix.setCustomAttribute(k, userAttrs[k]);
            });

            Toast.fire({ icon: "success", title: "User Updated" });
          };

          document.getElementById("sample-event-button").onclick = () => {
            const slug = document
              .getElementById("sample-event-c-slug-input")
              .value.trim();
            if (!slug) return;
            const attrs = collectAttributesFrom("slug-attributes-container");
            Metrix.newEvent(slug, attrs);
            Toast.fire({ icon: "success", title: "Event Sent By Slug" });
          };
          document.getElementById("sample-event-c-slug-input").oninput = (
            e
          ) => {
            const v = e.target.value;
            document.getElementById("sample-event-button").disabled = !(
              v.length === 5
            );
          };

          document.getElementById("sample-name-event-button").onclick = () => {
            const name = document
              .getElementById("sample-name-event-c-input")
              .value.trim();
            if (!name) return;
            const attrs = collectAttributesFrom("name-attributes-container");
            Metrix.newEvent(name, attrs);
            Toast.fire({ icon: "success", title: "Event Sent By Name" });
          };
          document.getElementById("sample-name-event-c-input").oninput = (
            e
          ) => {
            const v = e.target.value;
            document.getElementById("sample-name-event-button").disabled =
              !v.length;
          };
          document.getElementById("sample-business-event-button").onclick =
            () => {
              const slug = document
                .getElementById("sample-business-event-c-slug-input")
                .value.trim();
              if (!slug) return;

              const attributes = collectAttributesFrom(
                "business-attributes-container"
              );

              // read current apiKey & appId saved in localStorage (or inputs)
              const curApiKey =
                localStorage.getItem("apiKey") ||
                document.getElementById("init-apikey-input").value.trim();
              const curAppId =
                localStorage.getItem("appId") ||
                document.getElementById("init-appid-input").value.trim();

              const myHeaders = new Headers();
              myHeaders.append("content-type", "application/json");
              if (curApiKey) myHeaders.append("x-api-key", curApiKey);
              if (curAppId) myHeaders.append("x-application-id", curAppId);

              function generateUUID() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                  /[xy]/g,
                  function (c) {
                    const r = (Math.random() * 16) | 0;
                    const v = c === "x" ? r : (r & 0x3) | 0x8;
                    return v.toString(16);
                  }
                );
              }

              const raw = JSON.stringify({
                messages: [
                  {
                    type: "businessEvent",
                    id: generateUUID(),
                    time: Date.now(),
                    name: slug,
                    attributes: attributes,
                  },
                ],
              });

              const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: raw,
                redirect: "follow",
              };

              fetch(
                typeof useStg !== "undefined" && useStg
                  ? "https://stg-entry.metrix.ir/"
                  : "https://entry.metrix.ir/",
                requestOptions
              )
                .then((response) => response.text())
                .then((result) => {
                  console.log(result);
                  Toast.fire({ icon: "success", title: "Business Event Sent" });
                })
                .catch((error) => {
                  console.error(error);
                  Toast.fire({ icon: "error", title: "Business Event failed" });
                });
            };
          document.getElementById(
            "sample-business-event-c-slug-input"
          ).oninput = (e) => {
            const v = e.target.value;
            document.getElementById("sample-business-event-button").disabled =
              !(v.length === 5);
          };

          document.getElementById("stg-checkbox").onchange = (event) => {
            const checkboxValue = event.target.checked;
            localStorage.setItem("useStg", checkboxValue);
            setTimeout(() => closeSession(), 50);
          };
        }
      </script>

      <script>
        const script = document.createElement("script");
        const useStg =
          localStorage.getItem("useStg") &&
          localStorage.getItem("useStg") !== "false";
        script.src = useStg
          ? "./metrix.umd-latest-stg.js"
          : "https://cdn.metrix.ir/sdk/web/metrix.umd-2.5.0.js";
        script.onload = () => {
          try {
            mainThread();
          } catch (err) {
            console.error(err);
          }
        };
        document.getElementsByTagName("main")[0].appendChild(script);
      </script>
    </main>
  </body>
</html>
