<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Metrix SDK Demo</title>

    <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background-color: #f9fafb;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #111827;
        margin: 0;
        padding: 0;
      }

      main {
        max-width: 1100px;
        margin: 20px auto;
        padding: 20px;
      }

      .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 24px;
        margin-bottom: 24px;
        transition: 0.2s ease;
      }

      .card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      h3,
      h4,
      h5 {
        margin-top: 12px;
        margin-bottom: 8px;
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      input[type="password"],
      input[type="checkbox"],
      input:not([type]),
      button {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }

      input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }

      label {
        font-weight: 500;
      }

      button {
        background-color: #2563eb;
        color: white;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: 0.2s ease;
        margin-top: 10px;
      }

      button:hover {
        background-color: #1e40af;
      }

      button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        align-items: center;
      }

      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      hr {
        margin: 30px 0;
        border: 0;
        border-top: 1px solid #e5e7eb;
      }

      #init-status,
      #login-status {
        font-weight: bold;
        margin-top: 10px;
      }

      @media (max-width: 768px) {
        main {
          padding: 16px;
        }

        .card {
          padding: 16px;
        }

        button {
          font-size: 0.95rem;
        }

        h3 {
          font-size: 1.1rem;
        }
      }
    </style>

    <script>
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        },
      });
    </script>
  </head>

  <body>
    <main>
      <!-- INIT SECTION -->
      <div class="card">
        <div class="flex-between">
          <h2>Metrix SDK Initialization</h2>
          <div>
            <label for="stg-checkbox">Use Staging:</label>
            <input
              type="checkbox"
              id="stg-checkbox"
              style="transform: scale(1.3)"
            />
          </div>
        </div>
        <div class="row">
          <div>
            <label>App ID:</label>
            <input id="init-appid-input" placeholder="Enter App ID" />
          </div>
          <div>
            <label>API Key:</label>
            <input id="init-apikey-input" placeholder="Enter API Key" />
          </div>
          <div>
            <label>Push public key (optional):</label>
            <input
              id="init-public-key-input"
              placeholder="Public Key (optional)"
            />
          </div>
        </div>
        <div class="row">
          <button id="init-button">Initialize SDK</button>
          <button id="close-button" style="background-color: #ef4444">
            Close Session
          </button>
        </div>
        <p id="init-status" style="color: red">Not initialized</p>
      </div>

      <!-- EVENT SECTION -->
      <div id="send-event-box" hidden>
        <div class="card">
          <h3>User Authentication</h3>
          <div class="row">
            <input id="login-input" placeholder="customer@mycompany.com" />
            <button id="login-button">Login</button>
            <button id="logout-button" style="background-color: #f59e0b">
              Logout
            </button>
          </div>
          <p id="login-status" style="color: red">You're anonymous</p>
        </div>

        <!-- USER ATTRIBUTES -->
        <div class="card">
          <input type="checkbox" id="show-user-send" />
          <label for="show-user-send"
            ><strong>Show user attribute section</strong></label
          >

          <div id="send-user-box" hidden>
            <div class="row">
              <div>
                <label>First Name:</label>
                <input id="first-name-input" placeholder="First Name" />
              </div>
              <div>
                <label>Last Name:</label>
                <input id="last-name-input" placeholder="Last Name" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Phone Number:</label>
                <input id="phone-input" placeholder="Phone Number" />
              </div>
              <div>
                <label>Email:</label>
                <input id="email-input" placeholder="Email" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>City:</label>
                <input id="city-input" placeholder="City" />
              </div>
              <div>
                <label>Birth Date:</label>
                <input id="birth-date-input" placeholder="Timestamp" />
              </div>
            </div>

            <h4>Custom Attributes:</h4>
            <div class="row">
              <input id="user-c-att-key-input" placeholder="Key 1" />
              <input id="user-c-att-value-input" placeholder="Value 1" />
            </div>
            <div class="row">
              <input id="user-c-att-key2-input" placeholder="Key 2" />
              <input id="user-c-att-value2-input" placeholder="Value 2" />
            </div>

            <button id="user-att-button">Send User Attributes</button>
          </div>
        </div>

        <!-- EVENTS -->
        <div id="event-box" hidden>
          <div class="card">
            <h3>Send Event by Slug</h3>
            <input id="sample-event-c-slug-input" placeholder="Event Slug" />
            <div class="row">
              <input id="sample-event-c-att-key-input" placeholder="Key 1" />
              <input
                id="sample-event-c-att-value-input"
                placeholder="Value 1"
              />
            </div>
            <div class="row">
              <input id="sample-event-c-att-key2-input" placeholder="Key 2" />
              <input
                id="sample-event-c-att-value2-input"
                placeholder="Value 2"
              />
            </div>
            <button id="sample-event-button" disabled>
              Send Event by Slug
            </button>
          </div>

          <div class="card">
            <h3>Send Event by Name</h3>
            <input id="sample-name-event-c-input" placeholder="Event Name" />
            <div class="row">
              <input
                id="sample-name-event-c-att-key-input"
                placeholder="Key 1"
              />
              <input
                id="sample-name-event-c-att-value-input"
                placeholder="Value 1"
              />
            </div>
            <div class="row">
              <input
                id="sample-name-event-c-att-key2-input"
                placeholder="Key 2"
              />
              <input
                id="sample-name-event-c-att-value2-input"
                placeholder="Value 2"
              />
            </div>
            <button id="sample-name-event-button" disabled>
              Send Event by Name
            </button>
          </div>

          <div class="card">
            <h3>Business Event by Slug</h3>
            <input
              id="sample-business-event-c-slug-input"
              placeholder="Business Event Slug"
            />
            <div class="row">
              <input
                id="sample-business-event-c-att-key-input"
                placeholder="Key 1"
              />
              <input
                id="sample-business-event-c-att-value-input"
                placeholder="Value 1"
              />
            </div>
            <div class="row">
              <input
                id="sample-business-event-c-att-key2-input"
                placeholder="Key 2"
              />
              <input
                id="sample-business-event-c-att-value2-input"
                placeholder="Value 2"
              />
            </div>
            <button id="sample-business-event-button" disabled>
              Send Business Event
            </button>
          </div>
        </div>
      </div>

      <!-- Main JS -->
      <script>
        function mainThread() {
          let username = localStorage.getItem("username");
          const appId = localStorage.getItem("appId");
          const apiKey = localStorage.getItem("apiKey");
          const publicKey = localStorage.getItem("publicKey");

          const stgCheckbox = document.getElementById("stg-checkbox");
          stgCheckbox.checked = useStg;

          if (appId && apiKey) {
            const config = {
              push: {
                enabled: !!publicKey,
                publicKey: publicKey || undefined,
                showBell: !!publicKey,
              },
              onSiteMessaging: {
                enabled: true,
              },
            };
            Metrix.init(appId, apiKey, config);
            document.getElementById("init-appid-input").value = appId;
            document.getElementById("init-apikey-input").value = apiKey;
            document.getElementById("init-public-key-input").value =
              publicKey || "";
            document.getElementById("init-status").innerText =
              "Metrix initialized";
            document.getElementById("init-status").style.color = "green";
            document.getElementById("send-event-box").removeAttribute("hidden");
            document.getElementById("init-button").disabled = true;
          }

          if (username) {
            document.getElementById("login-status").innerHTML =
              "You're logged in as: " + username;
            document.getElementById("login-status").style.color = "green";
            document.getElementById("login-button").disabled = true;
            username = document.getElementById("login-input").value = username;
            document.getElementById("event-box").removeAttribute("hidden");
            Metrix.authorizeUser(username);
          }

          document.getElementById("init-button").onclick = () => {
            const appId = document.getElementById("init-appid-input").value;
            const apiKey = document.getElementById("init-apikey-input").value;
            const publicKey = document.getElementById(
              "init-public-key-input"
            ).value;

            if (appId.length && apiKey.length) {
              localStorage.setItem("appId", appId);
              localStorage.setItem("apiKey", apiKey);
              if (publicKey.length) {
                localStorage.setItem("publicKey", publicKey);
              } else {
                localStorage.removeItem("publicKey");
              }

              document.getElementById("init-status").innerText =
                "Metrix initialized";
              document.getElementById("init-status").style.color = "green";

              const config = {
                push: {
                  enabled: !!publicKey.length,
                  publicKey: publicKey || undefined,
                  showBell: !!publicKey.length,
                },
                onSiteMessaging: {
                  enabled: true,
                },
              };

              Metrix.init(appId, apiKey, config);
              document
                .getElementById("send-event-box")
                .removeAttribute("hidden");
            }
          };

          function closeSession() {
            localStorage.removeItem("appId");
            localStorage.removeItem("apiKey");
            localStorage.removeItem("username");
            localStorage.removeItem("publicKey");
            Metrix.deauthorizeUser();
            window.location.reload();
          }

          document.getElementById("close-button").onclick = () => {
            closeSession();
          };

          document.getElementById("login-button").onclick = () => {
            username = document.getElementById("login-input").value;
            if (username.length) {
              localStorage.setItem("username", username);
              Metrix.authorizeUser(username);
              document.getElementById("login-status").innerHTML =
                "You're logged in as: " + username;
              document.getElementById("login-status").style.color = "green";
              document.getElementById("event-box").removeAttribute("hidden");
            }
          };

          document.getElementById("logout-button").onclick = () => {
            username = undefined;
            localStorage.removeItem("username");
            Metrix.deauthorizeUser();
            document.getElementById("login-button").disabled = false;
            document.getElementById("login-input").value = "";
            document.getElementById("login-status").innerHTML =
              "You're logged out!!!";
            document.getElementById("login-status").style.color = "red";
            document.getElementById("event-box").setAttribute("hidden", "");
          };

          document.getElementById("show-user-send").onchange = (e) => {
            const checked = e.target.checked;
            const userSendBox = document.getElementById("send-user-box");
            if (checked) {
              userSendBox.removeAttribute("hidden");
            } else {
              userSendBox.setAttribute("hidden", "");
            }
          };

          document.getElementById("user-att-button").onclick = () => {
            const firstname = document.getElementById("first-name-input").value;
            const lastname = document.getElementById("last-name-input").value;
            const phone = document.getElementById("phone-input").value;
            const email = document.getElementById("email-input").value;
            const city = document.getElementById("city-input").value;
            const birthDate = document.getElementById("birth-date-input").value;
            const key = document.getElementById("user-c-att-key-input").value;
            const value = document.getElementById(
              "user-c-att-value-input"
            ).value;
            const key2 = document.getElementById("user-c-att-key2-input").value;
            const value2 = document.getElementById(
              "user-c-att-value2-input"
            ).value;

            if (firstname) Metrix.setFirstName(firstname);
            if (lastname) Metrix.setLastName(lastname);
            if (phone) Metrix.setPhoneNumber(phone);
            if (email) Metrix.setEmail(email);
            if (city) Metrix.setCity(city);
            if (birthDate) Metrix.setBirthday(birthDate);
            if (key && value) Metrix.setCustomAttribute(key, value);
            if (key2 && value2) Metrix.setCustomAttribute(key2, value2);

            Toast.fire({
              icon: "success",
              title: "User Updated",
            });
          };

          document.getElementById("sample-event-button").onclick = () => {
            const key = document.getElementById(
              "sample-event-c-att-key-input"
            )?.value;
            const value = document.getElementById(
              "sample-event-c-att-value-input"
            )?.value;
            const key2 = document.getElementById(
              "sample-event-c-att-key2-input"
            )?.value;
            const value2 = document.getElementById(
              "sample-event-c-att-value2-input"
            )?.value;

            const attributes = {};
            if (key && value) attributes[key] = value;
            if (key2 && value2) attributes[key2] = value2;
            const eventSlug = document.getElementById(
              "sample-event-c-slug-input"
            ).value;
            if (eventSlug) {
              Metrix.newEvent(eventSlug, attributes);
              Toast.fire({
                icon: "success",
                title: "Event Sent By Slug",
              });
            }
          };

          document.getElementById("sample-name-event-button").onclick = () => {
            const key = document.getElementById(
              "sample-name-event-c-att-key-input"
            )?.value;
            const value = document.getElementById(
              "sample-name-event-c-att-value-input"
            )?.value;
            const key2 = document.getElementById(
              "sample-name-event-c-att-key2-input"
            )?.value;
            const value2 = document.getElementById(
              "sample-name-event-c-att-value2-input"
            )?.value;

            const attributes = {};
            if (key && value) attributes[key] = value;
            if (key2 && value2) attributes[key2] = value2;
            const eventName = document.getElementById(
              "sample-name-event-c-input"
            ).value;
            if (eventName) {
              // FIX: Use the same method as slug events
              Metrix.newEvent(eventName, attributes);
              Toast.fire({
                icon: "success",
                title: "Event Sent By Name",
              });
            }
          };

          document.getElementById("sample-business-event-button").onclick =
            () => {
              const key = document.getElementById(
                "sample-business-event-c-att-key-input"
              )?.value;
              const value = document.getElementById(
                "sample-business-event-c-att-value-input"
              )?.value;
              const key2 = document.getElementById(
                "sample-business-event-c-att-key2-input"
              )?.value;
              const value2 = document.getElementById(
                "sample-business-event-c-att-value2-input"
              )?.value;

              function generateUUID() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                  /[xy]/g,
                  function (c) {
                    const r = (Math.random() * 16) | 0;
                    const v = c === "x" ? r : (r & 0x3) | 0x8;
                    return v.toString(16);
                  }
                );
              }

              const attributes = {};
              if (key && value) attributes[key] = value;
              if (key2 && value2) attributes[key2] = value2;
              const eventSlug = document.getElementById(
                "sample-business-event-c-slug-input"
              ).value;
              if (eventSlug) {
                const myHeaders = new Headers();
                myHeaders.append("content-type", "application/json");
                myHeaders.append("x-api-key", apiKey);
                myHeaders.append("x-application-id", appId);

                const raw = JSON.stringify({
                  messages: [
                    {
                      type: "businessEvent",
                      id: generateUUID(),
                      time: Date.now(),
                      name: eventSlug,
                      attributes: attributes,
                    },
                  ],
                });

                const requestOptions = {
                  method: "POST",
                  headers: myHeaders,
                  body: raw,
                  redirect: "follow",
                };

                fetch(
                  useStg
                    ? "https://stg-entry.metrix.ir/"
                    : "https://entry.metrix.ir/",
                  requestOptions
                )
                  .then((response) => response.text())
                  .then((result) => {
                    console.log(result);
                    Toast.fire({
                      icon: "success",
                      title: "Event Sent",
                    });
                  })
                  .catch((error) => console.error(error));
              }
            };

          document.getElementById("sample-name-event-c-input").oninput = (
            e
          ) => {
            const value = e.target.value;
            document.getElementById("sample-name-event-button").disabled =
              !value.length;
          };

          document.getElementById("sample-event-c-slug-input").oninput = (
            e
          ) => {
            const value = e.target.value;
            document.getElementById("sample-event-button").disabled = !(
              value.length === 5
            );
          };

          document.getElementById(
            "sample-business-event-c-slug-input"
          ).oninput = (e) => {
            const value = e.target.value;
            document.getElementById("sample-business-event-button").disabled =
              !(value.length === 5);
          };

          document.getElementById("stg-checkbox").onchange = (event) => {
            const checkboxValue = event.target.checked;
            localStorage.setItem("useStg", checkboxValue);
            setTimeout(() => {
              closeSession();
            });
          };
        }
      </script>

      <script>
        const script = document.createElement("script");
        const useStg =
          localStorage.getItem("useStg") &&
          localStorage.getItem("useStg") !== "false";
        script.src = useStg
          ? "./metrix.umd-latest-stg.js"
          : "https://cdn.metrix.ir/sdk/web/metrix.umd-2.5.0.js";
        const main = document.getElementsByTagName("main")[0];
        script.onload = () => {
          mainThread();
        };
        main.appendChild(script);
      </script>
    </main>
  </body>
</html>
