<!DOCTYPE html>
<html lang="en">
<head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Metrix SDK HTML</title>
    <meta name="description" content="Generated by create next app">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });
    </script>
    <style>
        button:active {
            background: darkseagreen;
        }
        .card {
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
            width: 40%;
        }

        .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
        }

        .container {
            padding: 16px;
        }
    </style>
</head>
<body>
<main>
    <div style="display: flex; justify-content: space-between">
        <div>
            <h3>App ID:</h3>
            <input id="init-appid-input" placeholder="App ID">
            <h3>API Key:</h3>
            <input id="init-apikey-input" placeholder="API KEY">
            <h3>Push public key:</h3>
            <input id="init-public-key-input" placeholder="PUBLIC KEY">
            <button id="init-button">Init</button>
            <button id="close-button">Close</button>
            <p id="init-status" style="color: red;">Not initialized</p>
        </div>
        <div>
            Use Stg: <input type="checkbox" id="stg-checkbox" style="transform: scale(1.5)">
        </div>
    </div>
    <div id="send-event-box" hidden>
        <hr/>
        <div>
            <h3>Enter Your username:</h3>
            <input id="login-input" placeholder="customer@mycompany.com">
            <button id="login-button">Login</button>
            <button id="logout-button">Logout</button>
            <p id="login-status" style="color: red">Your Anonymous!!!</p>
        </div>
        <input type="checkbox" id="show-user-send" name="vehicle1">
        <label for="show-user-send">
            <h4>I want to update user</h4>
        </label>
        <div id="send-user-box" hidden>
            <h3>Send sample user attribute</h3>
            <h5>Attributes:</h5>
            <div style="display: flex; justify-content: space-between"><label for="first-name-input">First
                Name:</label><input id="first-name-input" placeholder="First Name"></div>
            <div style="display: flex; justify-content: space-between"><label for="last-name-input">Last Name:</label><input
                    id="last-name-input" placeholder="Last Name"></div>
            <div style="display: flex; justify-content: space-between"><label for="phone-input">Phone Number:</label><input
                    id="phone-input" placeholder="Phone Number"></div>
            <div style="display: flex; justify-content: space-between"><label for="phone-input">Email:</label><input
                    id="email-input" placeholder="Email"></div>
            <div style="display: flex; justify-content: space-between"><label for="city-input">City:</label><input
                    id="city-input" placeholder="City"></div>
            <div style="display: flex; justify-content: space-between"><label for="birth-date-input">Birth Date:</label><input
                id="birth-date-input" placeholder="Timestamp"></div>
            <h5>Custom Attributes:</h5>
            <div style="display: flex; justify-content: space-between">
                <label for="user-c-att-key-input">Key:</label><input id="user-c-att-key-input" placeholder="key">
                <label for="user-c-att-value-input">Value:</label><input id="user-c-att-value-input" placeholder="value">
            </div>
            <div style="display: flex; justify-content: space-between">
                <label for="user-c-att-key2-input">Key:</label><input id="user-c-att-key2-input" placeholder="key">
                <label for="user-c-att-value2-input">Value:</label><input id="user-c-att-value2-input" placeholder="value">
            </div>
            <button id="user-att-button">Send User</button>
        </div>
        <div id="event-box" hidden>
           <hr/>
           <div id="general-event">
               <div style="margin-top: 100px">
                   <h3>Send
                       <span style="color: red; font-weight: bold">Sample Event With Slug</span>
                       event with custom attribute:</h3>
                   <h4>Event Slug:</h4>
                   <input id="sample-event-c-slug-input" placeholder="Event Slug">
                   <h4>Custom attributes (Optional): </h4>
                   <div style="display: flex; justify-content: space-between">
                       <label for="sample-event-c-att-key-input">Key:</label><input id="sample-event-c-att-key-input" placeholder="key">
                       <label for="sample-event-c-att-value-input">Value:</label><input id="sample-event-c-att-value-input" placeholder="value">
                   </div>
                   <div style="display: flex; justify-content: space-between">
                       <label for="sample-event-c-att-key2-input">Key:</label><input id="sample-event-c-att-key2-input" placeholder="key">
                       <label for="sample-event-c-att-value2-input">Value:</label><input id="sample-event-c-att-value2-input" placeholder="value">
                   </div>
                   <button id="sample-event-button" disabled>Send <span style="color: yellowgreen; font-weight: bold">Sample Event</span></button>
               </div>
           </div>

            <hr/>
            <div id="business-event">
                <div style="margin-top: 100px">
                    <h3>Send
                        <span style="color: mediumpurple; font-weight: bold">Business Event With Slug</span>
                        event with custom attribute:</h3>
                    <h4>Business Event Slug:</h4>
                    <input id="sample-business-event-c-slug-input" placeholder="Business Event Slug">
                    <h4>Custom attributes (Optional): </h4>
                    <div style="display: flex; justify-content: space-between">
                        <label for="sample-business-event-c-att-key-input">Key:</label><input id="sample-business-event-c-att-key-input" placeholder="key">
                        <label for="sample-business-event-c-att-value-input">Value:</label><input id="sample-business-event-c-att-value-input" placeholder="value">
                    </div>
                    <div style="display: flex; justify-content: space-between">
                        <label for="sample-business-event-c-att-key2-input">Key:</label><input id="sample-business-event-c-att-key2-input" placeholder="key">
                        <label for="sample-business-event-c-att-value2-input">Value:</label><input id="sample-business-event-c-att-value2-input" placeholder="value">
                    </div>
                    <button id="sample-business-event-button" disabled>Send <span style="color: orchid; font-weight: bold">Business Event</span></button>
                </div>
            </div>
    </div>

    </div>
    <script>
        function mainThread() {
            let username = localStorage.getItem("username");
            const appId = localStorage.getItem('appId');
            const apiKey = localStorage.getItem('apiKey');
            const publicKey = localStorage.getItem('publicKey');


            const stgCheckbox = document.getElementById('stg-checkbox')
            stgCheckbox.checked = useStg

            if (appId && apiKey && publicKey) {

                const config = {
                    push: {
                        enabled : true, // defaults to false but if set to true you must provide publicKey.
                        publicKey: publicKey, // your push subscription public key.
                        showBell: true
                    },
                    onSiteMessaging: {
                        enabled: true
                    }
                }
                Metrix.init(appId, apiKey, config);
                document.getElementById('init-appid-input').value = appId;
                document.getElementById('init-apikey-input').value = apiKey;
                document.getElementById('init-public-key-input').value = publicKey;
                document.getElementById('init-status').innerText = 'Metrix initialized';
                document.getElementById('init-status').style.color = 'green'
                document.getElementById('send-event-box').removeAttribute('hidden');
                document.getElementById('init-button').disabled = true;
            }

            if (username) {
                document.getElementById("login-status").innerHTML = "You're logged in as: " + username;
                document.getElementById("login-status").style.color = 'green';
                document.getElementById("login-button").disabled = true
                username = document.getElementById("login-input").value = username;
                document.getElementById('event-box').removeAttribute('hidden')
                Metrix.authorizeUser(username)
            }

            document.getElementById('init-button').onclick = () => {
                const appId = document.getElementById('init-appid-input').value;
                const apiKey = document.getElementById('init-apikey-input').value;
                const publicKey = document.getElementById('init-public-key-input').value;
                if (appId.length && apiKey.length && publicKey.length) {
                    localStorage.setItem('appId', appId);
                    localStorage.setItem('apiKey', apiKey);
                    localStorage.setItem('publicKey', publicKey);
                    document.getElementById('init-status').innerText = 'Metrix initialized';
                    document.getElementById('init-status').style.color = 'green';
                    const config = {
                        push: {
                            enabled : true, // defaults to false but if set to true you must provide publicKey.
                            publicKey: publicKey, // your push subscription public key.
                            showBell: true
                        },
                        onSiteMessaging: {
                            enabled: true
                        }
                    }
                    Metrix.init(appId, apiKey, config);
                    document.getElementById('send-event-box').removeAttribute('hidden')
                }
            }

            function closeSession() {
                localStorage.removeItem('appId');
                localStorage.removeItem('apiKey');
                localStorage.removeItem("username");
                localStorage.removeItem('publicKey')
                Metrix.deauthorizeUser()
                window.location.reload();
            }

            document.getElementById('close-button').onclick = () => {
                closeSession()
            }

            document.getElementById("login-button").onclick = () => {
                username = document.getElementById("login-input").value;
                if (username.length) {
                    localStorage.setItem("username", username)
                    Metrix.authorizeUser(username)
                    document.getElementById("login-status").innerHTML = "You're logged in as: " + username;
                    document.getElementById("login-status").style.color = 'green';
                    document.getElementById('event-box').removeAttribute('hidden')
                }
            }

            document.getElementById("logout-button").onclick = () => {
                username = undefined
                localStorage.removeItem("username")
                Metrix.deauthorizeUser()
                document.getElementById("login-button").disabled = false;
                document.getElementById('login-input').value = '';
                document.getElementById("login-status").innerHTML = "You're logged out!!!"
                document.getElementById("login-status").style.color = "red";
                document.getElementById('event-box').setAttribute('hidden', '')

            }

            document.getElementById('show-user-send').onchange = (e) => {
                const checked = e.target.checked;
                const userSendBox = document.getElementById('send-user-box')
                if (checked) {
                    userSendBox.removeAttribute('hidden')
                } else {
                    userSendBox.setAttribute('hidden', '')
                }
            }

            document.getElementById("user-att-button").onclick = () => {
                const firstname = document.getElementById("first-name-input").value;
                const lastname = document.getElementById("last-name-input").value;
                const phone = document.getElementById("phone-input").value;
                const email = document.getElementById("email-input").value;
                const city = document.getElementById('city-input').value;
                const birthDate = document.getElementById('birth-date-input').value;
                const key = document.getElementById("user-c-att-key-input").value;
                const value = document.getElementById("user-c-att-value-input").value;
                const key2 = document.getElementById("user-c-att-key2-input").value;
                const value2 = document.getElementById("user-c-att-value2-input").value;

                if (firstname)
                    Metrix.setFirstName(firstname)

                if (lastname)
                    Metrix.setLastName(lastname)

                if (phone)
                    Metrix.setPhoneNumber(phone)

                if (email)
                    Metrix.setEmail(email)

                if (city)
                    Metrix.setCity(city);

                if (birthDate)
                    Metrix.setBirthday(birthDate);

                if (key && value)
                    Metrix.setCustomAttribute(key, value)
                if (key2 && value2)
                    Metrix.setCustomAttribute(key2, value2)

                Toast.fire({
                    icon: "success",
                    title: "User Updated"
                });

            }




            document.getElementById("sample-event-button").onclick = () => {
                const key = document.getElementById("sample-event-c-att-key-input")?.value;
                const value = document.getElementById("sample-event-c-att-value-input")?.value;
                const key2 = document.getElementById("sample-event-c-att-key2-input")?.value;
                const value2 = document.getElementById("sample-event-c-att-value2-input")?.value;

                const attributes = {};
                if (key && value)
                    attributes[key] = value;
                if (key2 && value2)
                    attributes[key2] = value2;
                const eventSlug = document.getElementById('sample-event-c-slug-input').value;
                if (eventSlug) {
                    Metrix.newEvent(eventSlug, attributes);
                    Toast.fire({
                        icon: "success",
                        title: "Event Sent"
                    });
                }
            }

            document.getElementById("sample-business-event-button").onclick = () => {
                const key = document.getElementById("sample-business-event-c-att-key-input")?.value;
                const value = document.getElementById("sample-business-event-c-att-value-input")?.value;
                const key2 = document.getElementById("sample-business-event-c-att-key2-input")?.value;
                const value2 = document.getElementById("sample-business-event-c-att-value2-input")?.value;

                function generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                const attributes = {};
                if (key && value)
                    attributes[key] = value;
                if (key2 && value2)
                    attributes[key2] = value2;
                const eventSlug = document.getElementById('sample-business-event-c-slug-input').value;
                if (eventSlug) {

                    const myHeaders = new Headers();
                    myHeaders.append("content-type", "application/json");
                    myHeaders.append("x-api-key", apiKey);
                    myHeaders.append("x-application-id", appId);

                    const raw = JSON.stringify({
                        "messages": [
                            {
                                "type": "businessEvent",
                                "id": generateUUID(),
                                "time": Date.now(),
                                "name": eventSlug,
                                "attributes": attributes
                            }
                        ]
                    });

                    const requestOptions = {
                        method: "POST",
                        headers: myHeaders,
                        body: raw,
                        redirect: "follow"
                    };

                    fetch(useStg ? "https://stg-entry.metrix.ir/" : "https://entry.metrix.ir/", requestOptions)
                        .then((response) => response.text())
                        .then((result) => {
                            console.log(result)
                            Toast.fire({
                                icon: "success",
                                title: "Event Sent"
                            });
                        })
                        .catch((error) => console.error(error));
                }
            }

            document.getElementById('sample-event-c-slug-input').oninput = (e) => {
                const value = e.target.value;
                document.getElementById('sample-event-button').disabled = !(value.length === 5)
            }

            document.getElementById('sample-business-event-c-slug-input').oninput = (e) => {
                const value = e.target.value;
                document.getElementById('sample-business-event-button').disabled = !(value.length === 5)
            }

            document.getElementById('stg-checkbox').onchange = (event) => {
                const checkboxValue = event.target.checked;
                localStorage.setItem('useStg', checkboxValue);
                setTimeout(() => {
                    closeSession();
                })
            }
        }
    </script>


    <script>
        const script = document.createElement('script');
        const useStg = localStorage.getItem("useStg") && (localStorage.getItem("useStg") !== 'false');
        script.src = useStg ? './metrix.umd-latest-stg.js' : 'https://cdn.metrix.ir/sdk/web/metrix.umd-2.5.0.js';
        const main = document.getElementsByTagName('main')[0];
        script.onload = () => {
            mainThread()
        }
        main.appendChild(script)
    </script>
</main>
</body>
</html>